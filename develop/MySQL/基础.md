# MySQL执行流程
![[Pasted image 20250512111141.png]]
## 第一步：连接器
执行语句进行连接
```
# -h指定IP地址，如果连接的是本地的MySQL服务，可以不认这个参数
# -u指定用户名，管理员角色名为root
# -p指定密码，如果命令行中不填写密码，就需要再交互对话里面输入密码
mysql -h$ip -u$user -p
```
连接的过程基于TCP协议进行传输，连接的过程需要三次握手

## 查询缓存
select语句会缓存起来，下一次运行相同的语句会到缓存中查询执行结果。但是因为很鸡肋，所以8.0版本直接删掉了查询缓存。

## 解析SQL
不重要

## 执行SQL
- 预处理器 
	- 检查SQL查询语句中的表或者字段是否存在
	- 将select * 中的* 符号，拓展为表上的所有列
- 优化器，基于查询成本的考虑，将查询语句的执行方案确定下来
- 执行器， 这里最好看一下原文章，根据执行计划执行SQL查询语句，从存储引擎读取记录，返回给客户端

****
# MySQL一行记录是如何存储的
****
MySQL存储的行为是由存储引擎实现的，默认的是InnoDB。
每创建一个数据库都会在/var/lib/mysql/目录里面创建一个以database名的文件夹，保存表结构和表数据的文件都会存放在这里
创建一个表会有三个文件，
- db.opt用来存储当前数据库的默认字符集和字符校验规则
- .frm爆操每个表的元数据信息，主要包含表结构定义
- .ibd文件存放表数据，也叫独占表空间结构。表数据还可以存在共享表空间文件（ibdata1）里，这个操作是由参数控制的

## 表空间文件的结构
InnoDB存储引擎的逻辑存储结构大致如下
![[Pasted image 20250512160619.png]]

1. 行，记录都是按行进行存放的，每个记录根据不同的行格式，有不同的存储结构
2. 页，是InnoDB读写数据的最小单位，表中的记录存储在数据页中
3. 区，InnoDB是用B+树组织数据的。B+树中的每一层都是通过双向链表连接起来的，如果以页为单位来分配存储空间，那么链表中向领导的两个页之间的物理位置并不是连续的，可能离得非常远，那么磁盘查询时就会有大量的随机读写，随机读写时非常慢的。解决方式就是让链表中相邻页的物理位置也相邻，这样就可以使用顺序读写了，那么在范围查询（扫描叶子节点）的时候性能就会很高。在表中数据量大的时候，为某个索引分配空间的时候就不在按照页为单位分配了，而是按照区为单位分配。每个区的大小为1MB，对于16KB的页来说，连续的64个页会被化为一个区，这样就使得链表中相邻的页的物理位置页相邻了，就能使用顺序读写了。
4. 段，表空间是由段组成的，一个段是由多个区组成的，段分为：
	1. 索引段，存放B+树的非叶子节点的区的集合
	2. 数据段，存放B+树的叶子节点的区的集合
	3. 回滚段，存放的是回滚数据的区的集合，之前讲食物隔离的时候就介绍到了MVCC利用了回滚段实现了多版本的查询数据

## Inno行格式有哪些
四种：
- Redundant，很古老
- Compact，设计的初中就是为了让一个数据页可以存放更多的行记录
- Dynamic和Conpressed都是紧凑的行格式

### Compact格式
![[Pasted image 20250512163157.png]]
#### 记录的额外信息
1. 变长字段长度列表，存储数据的时候也要把数据占用的大小存到这里，读取数据的时候才能根据这个区读取对应长度的数据。当数据表没有变长字段的时候，这时候表里的行格式就不会有变长字段长度列表
2. NULL值列表，如果存在允许NULL值得列，则每个列对应一个二进制位，二进制位按照列得顺序逆序排列。如果表中没有NULL值列，则不会有NULL值列表，这样来节省空间
3. 记录头信息，delete_mask表示此条数据是否被删除，执行delete删除记录得时候不是真正得移除记录，只是将这个记录得delete_mask标记为1。next_record下一条得位置。record_type表示当前记录得类型，0表示普通记录，1表示B+树非叶子节点记录，2表示最小记录，3表示最大记录

#### 记录得真实数据
除了我们定义得字段，还有三个隐藏字段，row_id、trx_id、roll_pointer
- row_id，没有主键或唯一约束列得时候才存在，非必须
- trx_id，表示这个数据是由哪个事务生成的
- roll_pointer，这条记录上一个版本得指针，是必须的

## 行溢出
一个页的大小是16kb，也就是16384字节，这是存储一些大数据时就会发生行溢出，这时多的数据就会存到另外得到溢出页中
发生行溢出时，在记录的真实数据处只会记录该列一部分数据，把剩余数据放到溢出页中，然后真实数据处用20字节存储指向溢出页的地址